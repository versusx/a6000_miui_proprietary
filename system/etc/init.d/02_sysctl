#!/system/bin/sh
# Copyright (c) 2017, Stripalov. All rights reserved.
# Apply TCP tweaks
busybox sysctl -w net.ipv4.tcp_timestamps=0
busybox sysctl -w net.ipv4.tcp_tw_reuse=1
busybox sysctl -w net.ipv4.tcp_sack=1
busybox sysctl -w net.ipv4.tcp_tw_recycle=1
busybox sysctl -w net.ipv4.tcp_window_scaling=1
busybox sysctl -w net.ipv4.tcp_keepalive_probes=5
busybox sysctl -w net.ipv4.tcp_keepalive_intvl=30
busybox sysctl -w net.ipv4.tcp_fin_timeout=30
busybox sysctl -w net.core.wmem_max=404480
busybox sysctl -w net.core.rmem_max=404480
busybox sysctl -w net.core.rmem_default=256960
busybox sysctl -w net.core.wmem_default=256960
busybox sysctl -w net.ipv4.tcp_wmem=4096,16384,404480
busybox sysctl -w net.ipv4.tcp_rmem=4096,87380,404480
busybox sysctl -w net.ipv4.conf.all.rp_filter=2
busybox sysctl -w net.ipv4.conf.default.rp_filter=2
busybox sysctl -w net.ipv4.tcp_max_syn_backlog=1024
busybox sysctl -w net.ipv4.tcp_synack_retries=2
busybox sysctl -w net.ipv4.tcp_moderate_rcvbuf=1
busybox sysctl -w net.ipv4.icmp_echo_ignore_all=1
busybox sysctl -w net.ipv4.icmp_echo_ignore_broadcasts=1
busybox sysctl -w net.ipv4.icmp_ignore_bogus_error_responses=1
busybox sysctl -w net.ipv4.tcp_fin_timeout=15
busybox sysctl -w net.ipv4.route.flush=1
busybox sysctl -w net.ipv4.tcp_rfc1337=1
busybox sysctl -w net.ipv4.ip_no_pmtu_disc=0
busybox sysctl -w net.ipv4.tcp_ecn=0
busybox sysctl -w net.ipv4.tcp_fack=1
busybox sysctl -w net.ipv4.tcp_syn_retries=2
busybox sysctl -w net.ipv4.ip_forward=0
busybox sysctl -w net.ipv4.conf.all.accept_redirects=0
busybox sysctl -w net.ipv4.conf.all.secure_redirects=0
busybox sysctl -w net.ipv4.conf.all.send_redirects=0
busybox sysctl -w net.ipv4.conf.default.send_redirects=0
busybox sysctl -w net.ipv4.conf.default.accept_source_route=0
busybox sysctl -w net.ipv4.tcp_dsack=1
busybox sysctl -w net.ipv4.tcp_no_metrics_save=1
busybox sysctl -w net.core.netdev_max_backlog=30000
busybox sysctl -w net.ipv4.tcp_fastopen=1
busybox sysctl -w net.ipv4.tcp_slow_start_after_idle=0
# Apply VM tweaks
busybox sysctl -w vm.oom_dump_tasks=0
busybox sysctl -w vm.oom_kill_allocating_task=0
busybox sysctl -w vm.vfs_cache_pressure=10
busybox sysctl -w vm.overcommit_memory=1
busybox sysctl -w vm.overcommit_ratio=150
busybox sysctl -w vm.dirty_expire_centisecs=500
busybox sysctl -w vm.dirty_writeback_centisecs=3000
busybox sysctl -w vm.block_dump=0
busybox sysctl -w vm.laptop_mode=0
busybox sysctl -w vm.min_free_kbytes=512
busybox sysctl -w vm.extra_free_kbytes=1024
busybox sysctl -w vm.min_free_order_shift=5
busybox sysctl -w vm.page-cluster=0
busybox sysctl -w vm.dirty_background_ratio=10
busybox sysctl -w vm.dirty_ratio=20
busybox sysctl -w vm.swappiness=100
busybox sysctl -w vm.panic_on_oom=0
# Apply kernel tweaks
busybox sysctl -w kernel.random.read_wakeup_threshold=1708
busybox sysctl -w kernel.random.write_wakeup_threshold=2048
busybox sysctl -w kernel.msgmni=32768
busybox sysctl -w kernel.msgmax=8192
busybox sysctl -w kernel.msgmnb=16384
busybox sysctl -w kernel.shmmni=4096
busybox sysctl -w kernel.shmall=2097152
busybox sysctl -w kernel.shmmax=268435456
busybox sysctl -w kernel.sem='250 32000 100 128'
busybox sysctl -w fs.lease-break-time=8
busybox sysctl -w fs.inotify.max_queued_events=32768
busybox sysctl -w fs.inotify.max_user_instances=256
busybox sysctl -w fs.inotify.max_user_watches=16384
busybox sysctl -w fs.file-max=524288
busybox sysctl -w kernel.panic_on_oops=0
busybox sysctl -w kernel.panic=0
busybox sysctl -w fs.nr_open=1053696
busybox sysctl -w kernel.threads-max=525810
# Drop caches after applying settings
sync && busybox sysctl -w vm.drop_caches=3